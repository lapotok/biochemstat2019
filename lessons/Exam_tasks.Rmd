---
title: "Навыки и задания к экзамену"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Навыки

+ импортировать файлы
+ переформатировать данные из одной формы в другую 
  + например, длинная <-> широкая
  + несколько таблиц в одну по ключу
  + наблюдения <-> таблицы сопряженности
  + изменение в пределах группы через pipe/for
+ построение графиков
+ предпосылки о виде данных для различных анализов
  + незавимость
  + репрезентативность
  + нормальность
  + равенство дисперсий
+ сравнение групп
  + визуально
  + доверительные интервалы
    + для групповых средних
    + для различий между средними
    + независимые/одновременные
  + тесты
    + параметрические и непараметрические
    + что такое нуль распределение, p-value
    + множественное тестирование
    + необходимые сравнения
    + тестирование эквивалентности (equivalence, noninferiority & nonsuperiority tests)
  + регрессия + тесты
+ анализ зависимостей
  + корреляции
  + регрессия
    + линейная 
    + нелинейная
+ методы, основанные на симуляции
  + перестановки
  + ресэмплинг (бутстреп)

# Собственно, задания

## 1. Импорт и переформатирование данных

Есть кривые изменения ОД605 (измеряется образование окрашенного редокс-красителя) во времени при нескольких концентрациях NADPH.

[Выходной файл](https://github.com/lapotok/biochemstat2019/blob/master/data/dbass_kinetics.xlsx?raw=True) в формате Excel представляет собой один лист с подтабличками для каждой концентрации (имеется две повторности для каждой концентрации). В каждой подтаблице есть измерения ОД605 по временным точкам, среднее и стандартное отклонение между соседними четверками точек (а также еще температура, фиксируемая прибором).

Для дальшейшей обработки нужно импортировать исходный файл в `R` и создать одну общую таблицу со следующими колонками:

1. Номер повторности
2. Концентрация
2. Температура
3. Время
4. Показание ОД605
5. Усредненное показание
6. Стандартное отклонение для усредненного показания

(т.к. температура, усредненное показание и стандартное отклонения даны один раз на каждую четверку значений, можно записать эти значения на первую из 4 временных точек, а в остальных проставить NA)

Т.к. на первых порах непросто придумать алгоритм того, как можно считать данные с такой сложной структурой, распишу шаги того, как это можно сделать.

0. Посмотреть на файл в  Excel - как он устроен, какие части есть, в каком виде хотелось бы эти данные представить? (объяснение структуры см. выше)
1. Считать файл функцией `import()` (пакет `rio`);
2. Сохранить в объект;
3. Посмотреть на структуру полученного объекта, как он распознался, какие типы данных, сколько строк/колонок;
3. Инициировать таблицу, в которую мы будем собирать все данные;
4. Написать цикл, который будет сканировать первые ячейки каждой строки на наличие строки "Cycles / Well" (признак того, что дальше пойдет очередная подтаблица), запоминать текущий номер строки $i$.
5. Дальше нужно дописть в этом цикле действия, которые нужно совершить для каждой найденной подтаблицы. А именно, вы можете из каждой подтаблицы вытаскивать по относительным координатам какие-то данные, например, температуры как `d[i+2, 2:13]`.
6. В конце каждого цикла собранные данные нужно записать во временную таблицу и присоединить эту таблицу к общей таблице.

Далее по такой таблице нужно построить график зависимости ОД605 от времени, разбив по цветам (или подграфиками) разные концентрации NADPH.

Как вы думаете, что не так с данными и как это можно исправить? Для диагностики проблем можете построить какие-то дополнительные графики на Ваш вкус.

```{r eval=F, echo=F}
library(rio)
library(tidyverse)
library(magrittr)
library(drc)

# import
d = import("data/dbass_kinetics.xlsx")

# data reformatting
d_ = tibble()
i = 0
for (i in 1:nrow(d)){
  if(!is.na(d[i, 1]) & d[i, 1] == "Cycles / Well") {
    #print(i) # new plate is coming
    tr = list()
    tr$cycle = d[i+1, 1]
    tr$conc = d[i, 13] %>% str_split(" ", simplify = T) %>% .[1] %>% as.numeric()
    tr$time = c(
      d[i+6, 2:13],
      d[i+8, 2:13],
      d[i+10, 2:13],
      d[i+12, 2:13]
    ) %>% as.numeric()
    tr$abs = c(
      d[i+5, 2:13],
      d[i+7, 2:13],
      d[i+9, 2:13],
      d[i+11, 2:13]
    ) %>% as.numeric()
    tr$mean_temp = rep(
      d[i+2, 2:13], 
      times = 4
    ) %>% as.numeric()
    tr$mean_abs = c(
      d[i+3, 2:13], 
      rep(NA, 12*3)
    ) %>% as.numeric()
    tr$mean_sd = c(
      d[i+4, 2:13], 
      rep(NA, 12*3)
    ) %>% as.numeric()
    d_ = bind_rows(d_, as_tibble(tr))
  }
  i = i + 1
}

# general look
d_ %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=as.factor(conc)), alpha=.2, size=2) + 
  # geom_pointrange(aes(x=time, y=mean_abs, 
  #                     ymin=mean_abs-qt(0.975, df = 4-1)*mean_sd/sqrt(4), 
  #                     ymax=mean_abs+2*mean_sd/sqrt(2),
  #                     col=as.factor(conc))) +
  scale_color_brewer(palette="Dark2") + 
  theme_minimal() 

# split the replicas
d_ %>% 
  mutate(replica_name = str_sub(cycle,1,1)) %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=as.factor(conc)), alpha=.2, size=2) + 
  geom_pointrange(aes(x=time, y=mean_abs, 
                      ymin=mean_abs-qt(0.975, df = 4-1)*mean_sd/sqrt(4), 
                      ymax=mean_abs+2*mean_sd/sqrt(2),
                      col=as.factor(conc))) +
  facet_grid(replica_name ~ .) +
  scale_color_brewer(palette="Dark2") + 
  theme_minimal() 

# temp effect
d_ %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=mean_temp), alpha=.8, size=2) +
  theme_minimal() 

# outliers
d_ %>% 
  filter(conc > 20) %>% 
  mutate(time_group = round(time/100000)) %>% 
  group_by(time_group) %>% nest() %>% 
  mutate(
    Q1 = map(data, ~ quantile(.x$abs, .25)),
    Q3 = map(data, ~ quantile(.x$abs, .75))
  ) %>% unnest(c(data, Q1, Q3)) %>% 
  mutate(
    .is_outlier = # filtering by 1.5 IQR threshold
      abs < Q1 - 1.5 * (Q3-Q1) 
      | abs > Q3 + 1.5 * (Q3-Q1) 
  ) %>% 
  ungroup %>% 
  mutate(.trash =
           .is_outlier | time > 3.1e5 ) -> d__

d__ =
  d_ %>% 
  left_join(d__) %>% 
  mutate(.trash = ifelse(is.na(.trash), F, .trash))

d__ %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=as.factor(conc), shape=.is_outlier), alpha=.7, size=2) +
  theme_bw() +
  scale_shape_manual(values = c("TRUE"=4, "FALSE"=19)) +
  annotate("rect",xmin=3.1e5,xmax=Inf,ymin=-Inf,ymax=Inf, alpha=0.8, fill="white")

# corrected points
d__ %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=as.factor(conc), shape=.trash), alpha=.8, size=2) + 
  scale_color_brewer(palette="Dark2") + 
  scale_shape_manual(values = c("TRUE"=4, "FALSE"=19)) +
  theme_minimal() 


m = drm(abs ~ time, conc, data = d__ %>% filter(!.trash), fct=AR.3())
# AR.3 derivative
m_deriv = D(expression(c + (d-c) * (1 - exp(-x/e))), 'x')
# (d - c) * (exp(-x/e) * (1/e))
# x = 0 => (d - c) * (1/e)
m_coeff = coef(m)

d___ = tibble()
slopes = tibble()
for (i in unique(d_$conc)) {
  d_subset = d__ %>% filter(conc == i)
  m_coeff_subset = m_coeff[ paste(c("c",  "d", "e"), ":", i, sep="") ]
  slope = (m_coeff_subset[2] - m_coeff_subset[1]) * (1/m_coeff_subset[3]) 
  d_subset$der_pred = m_coeff_subset[1] + slope * d_subset$time
  d___ = bind_rows(d___, d_subset)
  slopes = bind_rows(slopes, tibble(conc=i, slope=slope))
}

d___$pred = predict(m, newdata = as.data.frame(d___))

d___ %>% 
  mutate(replica_name = str_sub(cycle,1,1)) %>% 
  ggplot() + 
  geom_point(aes(x=time, y=abs, col=as.factor(conc), shape = .trash), alpha=.5) + 
  geom_line(aes(x=time, y=pred, col=as.factor(conc)), alpha=.7, linetype="dashed") + 
  geom_line(aes(x=time, y=der_pred, col=as.factor(conc)), alpha=1) + 
  scale_color_brewer(palette="Dark2") +
  facet_grid(replica_name ~ conc) + 
  scale_shape_manual(values = c("TRUE"=4, "FALSE"=19)) +
  theme_minimal() + geom_vline(xintercept = 0) + geom_hline(yintercept = 0) +
  theme(axis.text.x = element_text(angle = 90)) + ylim(0.05, 0.3)

slopes %>% 
  ggplot(aes(x=conc, y=slope)) +
  geom_point() + 
  geom_smooth(method="lm")
```

## 2. Сравнение групп

На примере данных по стабильности белка, [уже рассматривавшихся в ДЗ](https://github.com/lapotok/biochemstat2019/blob/master/data/protein_stability.xlsx?raw=True) (белок хранился месяц при разных температурах и требуется определить, при какой температуре его допустимо хранить без видимой потери активности), рассмотрим стратегии сравнения групп.

1. Используем тесты (какой/какие подходят)? Почему? Что такое нулевое распределение статистики критерия? Что такое p-value?
2. Используем доверительные интервалы: какой/какие можно использовать для сравнения?
3. Что такое значимость (и какая она бывает)? Какие различия мы можем здесь считать значимыми? Как мы можем установить значимость различия и значимость его отсутствия?
4. Кажется, у нас тут более двух групп. Как это влияет на обработку данных?

```{r echo=F, eval=F}
ps = import("data/protein_stability.xlsx")

ps %>% 
  ggplot(aes(x=Sample, y= ConcUndiluted)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(alpha=.6, size=2, position = position_jitter(.2)) + 
  theme_classic()

ref_level = ps %>% filter(Sample == "-70") %>% pull(ConcUndiluted) %>% mean()

ps %<>% 
  mutate(ConcProc = ConcUndiluted / ref_level * 100)

ps %>% 
  ggplot(aes(x=Sample, y= ConcProc)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(alpha=.6, size=2, position = position_jitter(.2)) + 
  theme_classic()

# parametric, regression
m = lm(ConcProc ~ Sample, ps)
#plot(m)

m_emm = emmeans(m, "Sample")
m_emm %>% plot(comp=T)
m_emm %>% confint()
m_emm %>% contrast("dunnett", reverse = T)
m_emm %>% contrast("dunnett", reverse = T) %>% confint()
test(contrast(m_emm, "dunnett", reverse=T), delta = 10, side = "<")

# non-parametric: wilcox & kruskal
library(rstatix)
ps %>% kruskal_test(ConcProc ~ Sample) # => the is a difference
ps %>% wilcox_test(ConcProc ~ Sample, ref.group = "-70", alternative = "greater")
```

<!--
# Примеры задач, с которыми сталкиваются студенты

## Н.

1. сравнение двух S-образных кривых. Поиск различий

> кривые кинетики, флуоресценции

```{r eval=F, echo=F}
biz = import("data/bizyaev.xlsx", sheet=2)
biz[, c(1, 3:8)] %>%
  as_tibble() %>% 
  drop_na() %>% 
  set_colnames(c("time", "PCT_ref", "Luc_ref", "PCT1", "PCT2", "Luc1", "Luc2")) %>% 
  mutate(time = str_match(time, "[0-9]+") %>% as.numeric()) %>% 
  pivot_longer(-time) -> biz_

biz_ %>% 
  ggplot() +
  geom_point(aes(x=time, y=value, col=name)) 

m = drm(value ~ time, name, data=biz_, fct=LL.5())
plot(m, col=biz_$name %>% as.factor(), legendPos = c(40, 13000), log="")# 

m_coeff = m %>% coef()
m_coeff_luc1 = m_coeff[ paste0(str_split("bcdef", "")[[1]], ":", "Luc1") ]
# D(expression(c + (d-c)/((1+exp(b*(log(x)-log(e))))^f)), 'x')
f = function(x, b,c,d,e,f) {c + (d-c)/((1+exp(b*(log(x)-log(e))))^f)}
der_f = function(x, b,c,d,e,f) {-((d - c) * ((1 + exp(b * (log(x) - log(e))))^(f - 1) * (f * (exp(b * (log(x) - log(e))) * (b * (1/x)))))/((1 + exp(b * (log(x) - log(e))))^f)^2)}

x = 1:150
f_x = f(x, m_coeff_luc1[1], m_coeff_luc1[2], m_coeff_luc1[3], m_coeff_luc1[4], m_coeff_luc1[5])
df_x = der_f(x, m_coeff_luc1[1], m_coeff_luc1[2], m_coeff_luc1[3], m_coeff_luc1[4], m_coeff_luc1[5])

ggplot() + 
  geom_point(aes(x=time, y=value), alpha=.5, data=biz_ %>% filter(name == "Luc1")) +
  geom_line(aes(x=x, y=y), data = tibble(x=x, y=f_x)) +
  geom_line(aes(x=x, y=y), data = tibble(x=x, y=df_x*30), col="red", linetype="dotted") +
  geom_abline(slope=max(df_x), col="red", linetype="dashed") + theme_bw()
```

  
> ну к примеру можно взять нашу кинетическую кривую с дипломной работы. Мы по линейному участку там что-то считали и от выбора границ участка линейности константы прямой значительно менялись) Вы предлагали находить точку перегиба

2. вообще поиск наилучших границ линейной зависимости любой функции от концентрации с прибора
 
3. классическое биохимичечкое сравнение по 3 независимым точкам в каждой линии

> к примеру, интенсивность полосы блота

## Л.

1. установить, влияет ли на качество кристаллов факт, оставление
гистидинового тага у белка, т.е. сравнить две группы +/- таг, за параметр качества
взять разрешение от 1-3 ангстрем и частота в количестве кристаллов с таким разрешением;

2. установить, влияет ли на размер кристаллов применение процедуры микросидинга,
т.е. сравнить две группы +/- микросидинг,
размер от 50-1000 микрон и частота в количестве крситаллов;

> 1-2.: какой-то тест на сравнение двух групп

3. установить, есть ли зависимость между размером кристаллов и температурой при их росте
или концентрацией соли/осадителя пега;

4. сравнить несколько групп криорастворов для съемки кристаллов, например, влияет ли состав
крио (глицерин, пег 400, этиленгликоль, метилпентадиол или паратон) на полученное разрешение, найти отличие
и выбрать лучший.

> 3-4.: DOE в классическом виде ;)


## С.А.

1. Влияет ли на активность изучаемого фермента оставления гистидинового тага при выделении.

2. Установить возможную зависимость между активностью фермента и концентрацией ионов меди,
которой она активировалась.

3. Установить возможную зависимость между уровнем экспрессии изучаемого фермента и концентрацией
его субстрата в среде при росте клеток

> если цель - подбор условий, тогда ответ - DOE

## Б.А.

1. Измерение концентрации белка с помощью метода Лоури. Построение калибровочной кривой, определение линии тренда, максимально приближенной к кривой. Определение уравнения и нахождение концентраций образцов.

2. Нахождение достоверности различия между группами клеток после добавления различных лигандов. 1 группа - буфер, 2 группа - один лиганд, 3 группа - второй лиганд, 4 группа - оба лиганда.
Измерение интенсивности флуоресцентности кальциевого ответа после добавки.
Итого - после обработки серии слайдов с изменением интенсивности флуоресценции есть данные по 4 группам с mean по времени.

3. То же самое, что пункт 2, только отличие в типе клеток (дикие и мутантные), добавление одного и того же лиганда. Различаются ли ответы между двумя группами

## Р.

1. её я в будущем хотела бы решить, пока не знаю как. я работаю с абберантно гликозилированными клетками. мы нокаутируем шаперон гликозилтрансферазы, она ломается и перестает делать нормальный углеводный антиген, вместо него образуется куцый углеводный остаток. мы заметили, что такие модифицированные клетки гораздо хуже повергаются трипсинолизу (они прикрепленные). исходной культуре требуется инкубация минут 10 с трипсином- максимум, и они теряют контакты с поверхностью, ошариваются и превращаются в суспензию. модифицированным клеткам же требуется 30 (!) минут, и то их приходится все равно буквально сдирать с поверхности чашки струей из пипетки. очень интересно было бы как-то оценить, насколько сильно меняются адгезионные способности у модифицированных клеток. мне кажется, это не прям такая сложная задача, но мне она актуальна

2. делали мои знакомые-физиологи, занимающиеся всякими окислительными стрессами и ионами скулачева. они делали окислительный стресс нейронам, потом вводили туда какие-то антиоксиданты и делали с мышами поведенческие тесты (что-то вроде ориентирования, запоминания и т.д.). Был некоторый результат на обучаемость у мышей, которые ничему не подвергались (исходные). Но у тех мышей, у которых был окислительный стресс, обучаемость неожиданно возрастала. Они предполагают, что это связано с какими-то компенсаторными механизмами. Так вот, если вводить этот антиоксидант, то обучаемость падает до исходного уровня (типа снимается окислительный стресс). То есть результаты, по сути, положительные - антиоксидант, по идее, работает, но как учитывать такой вот странный эффект окислительного стресса

3. еще в нашей лаборатории изучают аллергии, в частности, на пыльцу березы. есть человек 30 доноров-аллергиков крови, в их крови мерят количество различных лейкоцитов. есть идея все это дело как-то наложить на календарь цветения березы, чтобы посмотреть, есть ли какая-то связь между изменением соотношения разных типов лейкоцитов с фазами цветения ( она, скорее всего, есть - они ж аллергики!) проблема в том, что они ходят на забор крови как хотят - то продалбываются, то принимают лекарства, то приезжают из других стран, где нет берез. то есть не бывает такой ситауции, чтобы раз в неделю все 30 человек дружно пришли и сдали кровь. в общем, все эти трудности надо как-то решить при нахождении зависимости

4. задача, с которой я столкнулась, когда работала в предыдущей лабе. в какой-то момент один нехороший человек в виварии взял и подсадил самца к самкам мышей. мы занимались костным мозгом на разных стадиях воспаления, вызванного туберкулезной инфекцией. мы не знали, в какой именно момент случилсь подсадка и какие из наших мышей оказались беременными. беременность, предположительно, могла влиять на протекание воспалительного процесса. можно ли как-то оценить, есть ли этот эффект, не зная, какие именно мыши беременные?

5. и последнее) у нас есть культура клеток, которую мы временно трансфицируем, и она выделяет нам белок под названием CD40L. проблема в том, что трансфекция временная, и синтез этого белка быстро падает. как нам оценить эффективность трансфекции (CD40L также экспонируется и на поверхности)? то есть трнсфекция могла пройти на 90%, а из-за того, что плазмида утрачивается, нам кажется, что гораздо хуже

## Д.

1. Не то чтобы это было сильно сложно, но я довольно регулярно строю близкое к бесконечному количество кинетик. То есть есть зависимость D от времени, при разных концентрациях реагентов у этой зависимости разный угол наклона, и в итоге нужно построить кинетики для нескольких концентраций в двух повторностях, посчитать углы наклона этих кинетик и построить зависимость угла наклона от концентрации реагента. Исходные данные в виде множества таблиц эксель.

2. Тоже вроде не сложно, но долго и нудно: нормализация параметров флуоресценции, например, яркости, на базовую линию. То есть микроскопируем клетки, в них что-то светится. Сначала снимаем базовую линию. Когда она более или менее стабилизируется, добавляем какое-нибудь вещество, от чего флуоресценция, например, разгорается. При этом исходно интенсивность свечения в разных клетках разная, но потом увеличивается в одинаковое число раз. Чтобы отклонение на графике не занимало полшкалы, мы находим какой-то стабильный участок на базовой линии и для каждой клетки делим значение в каждой точке на значение в этом стабильном участке. По идее, наверное, неплохо бы потом ещё проверять, насколько значимо кривая до добавки отличается от кривой после добавки.

3. Относительно той же флуоресцентной микроскопии: иногда нужна более продвинутая обработка с коррекцией на выцветание красителя. Не знаю, насколько это можно отнести к статистической обработке, и насколько это можно делать с нуля, потому что мы делаем это с помощью макроса в ImageJ.

4. Я измеряю концентрации NADPtotal и NADPH в клетках без и с воздействием разных веществ. В каждом опыте две технические повторности (для всех концентраций), и таких опытов (биологических повторностей) несколько. Потом я считаю соотношения NADPtotal/NADPH в контроле и опыте, и ещё есть мысль считать соотношение соотношений опыта к контролю. В какой-то момент я перестала понимать, учитываются ли технические повторности при подсчёте стандартных отклонений или только биологические (и можно ли здесь считать стандартные отклонения, ведь мы ничего не знаем о форме распределения) и можно ли здесь использовать парное сравнение (1 опыт и 1 контроль делаются параллельно).
-->